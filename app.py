from flask import Flask, render_template, jsonify
from pymongo import MongoClient
from bson import ObjectId
from dotenv import load_dotenv
import os

# Load environment variables from .env file
load_dotenv()

app = Flask(__name__)

# Get MongoDB credentials from environment variables
mongo_uri = os.getenv('mongodb+srv://yoelyy:Fafi12@cluster1.suarw8b.mongodb.net/?retryWrites=true&w=majority&tls=true&tlsAllowInvalidCertificates=true')

client = MongoClient(mongo_uri)
db = client.vulnerability_management
scans_collection = db.scans

def convert_object_id(data):
    if isinstance(data, list):
        for item in data:
            convert_object_id(item)
    elif isinstance(data, dict):
        for key, value in data.items():
            if isinstance(value, ObjectId):
                data[key] = str(value)
            elif isinstance(value, (dict, list)):
                convert_object_id(value)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/scans')
def get_scans():
    scans = list(scans_collection.find())
    convert_object_id(scans)
    return jsonify(scans)

if __name__ == '__main__':
    app.run(debug=True)
